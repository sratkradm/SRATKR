<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- GANTIKAN DENGAN URL LOGO ANDA -->
    <link rel="icon" type="image/png" href="https://kbwljjyzlmaclcrlmptg.supabase.co/storage/v1/object/public/images/jais.png"> 
    <title>Takwim Persekolahan - SRA Taman Kajang Raya</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sra: { primary: '#004D40', accent: '#FFC107', light: '#F5F5F5', dark: '#1F2937' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Style untuk kotak kalendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
        }
        .calendar-day-header {
            background-color: #004D40;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        @media (max-width: 640px) {
            .calendar-day { min-height: 80px; font-size: 0.8rem; }
            .event-badge { font-size: 0.65rem; padding: 2px; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-sra-primary text-white sticky top-0 z-50 shadow-lg border-b-4 border-sra-accent">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center space-x-3">
                <img src="https://kbwljjyzlmaclcrlmptg.supabase.co/storage/v1/object/public/images/jais.png" alt="Logo Sekolah" class="w-12 h-12 rounded-full object-cover border-2 border-sra-accent bg-white">
                <h1 class="text-md font-bold uppercase tracking-wide">SRA TAMAN KAJANG RAYA</h1>
            </a>
            <a href="/" class="text-sm font-bold hover:text-sra-accent"><i class="fas fa-home mr-2"></i> Utama</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 py-8">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-sra-primary">Takwim Persekolahan</h1>
            <p class="text-gray-600 mt-2">Jadual acara, peperiksaan dan cuti sekolah</p>
        </div>

        <!-- KALENDAR CONTAINER -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden max-w-5xl mx-auto mb-8">
            
            <!-- Controls (Bulan/Tahun) -->
            <div class="flex items-center justify-between p-6 bg-sra-light border-b">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-left fa-lg"></i>
                </button>
                
                <h2 id="current-month-year" class="text-2xl font-bold text-gray-800 uppercase">
                    <!-- Januari 2025 -->
                </h2>
                
                <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-right fa-lg"></i>
                </button>
            </div>

            <!-- Petunjuk Warna (Legend) -->
            <div class="flex flex-wrap gap-4 px-6 py-3 text-sm border-b bg-white">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-100 border border-red-500 mr-2"></span> Cuti</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-100 border border-yellow-500 mr-2"></span> Peperiksaan</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-100 border border-green-500 mr-2"></span> Program</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-100 border border-blue-500 mr-2"></span> Lain-lain</div>
            </div>

            <!-- Grid Kalendar -->
            <div class="calendar-grid" id="calendar-body">
                <div class="calendar-day-header">AHAD</div>
                <div class="calendar-day-header">ISNIN</div>
                <div class="calendar-day-header">SELASA</div>
                <div class="calendar-day-header">RABU</div>
                <div class="calendar-day-header">KHAMIS</div>
                <div class="calendar-day-header">JUMAAT</div>
                <div class="calendar-day-header">SABTU</div>
                <!-- Tarikh dijana oleh JS -->
            </div>
        </div>

        <!-- BUTANG SUMMARY (BARU) -->
        <div class="text-center">
            <button onclick="openSummaryModal()" class="inline-flex items-center bg-sra-accent text-sra-primary font-bold py-3 px-8 rounded-full shadow-lg hover:bg-yellow-400 hover:-translate-y-1 transition duration-300">
                <i class="fas fa-list-ul mr-3"></i> Lihat Ringkasan Tahunan
            </button>
            <p class="text-sm text-gray-500 mt-2">Klik untuk melihat senarai penuh aktiviti dalam bentuk jadual.</p>
        </div>

    </main>

    <!-- MODAL SUMMARY (POPUP LIST VIEW) -->
    <div id="summary-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeSummaryModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl max-h-[85vh] flex flex-col">
                    
                    <!-- Header Modal -->
                    <div class="bg-sra-primary px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                        <h3 class="text-lg font-bold text-white"><i class="fas fa-calendar-check mr-2"></i> Senarai Penuh Aktiviti</h3>
                        <button onclick="closeSummaryModal()" class="text-white hover:text-gray-300">
                            <i class="fas fa-times fa-lg"></i>
                        </button>
                    </div>

                    <!-- Body Modal (Scrollable Table) -->
                    <div class="p-6 overflow-y-auto">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-100 text-gray-700 text-sm uppercase">
                                        <th class="p-3 border-b font-bold w-1/4">Tarikh</th>
                                        <th class="p-3 border-b font-bold w-1/2">Acara</th>
                                        <th class="p-3 border-b font-bold w-1/4">Kategori</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="text-sm">
                                    <!-- List akan masuk sini -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-data-msg" class="hidden text-center py-8 text-gray-500">
                            Tiada acara ditemui.
                        </div>
                    </div>

                    <!-- Footer Modal -->
                    <div class="bg-gray-50 px-6 py-3 flex justify-end sticky bottom-0 z-20 border-t">
                        <button type="button" onclick="closeSummaryModal()" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto">
                            Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="bg-sra-primary text-gray-100 border-t-4 border-sra-accent py-6 text-center text-sm">
        <p>&copy; 2025 SRA Taman Kajang Raya.</p>
    </footer>

    <!-- LOGIK KALENDAR & SUMMARY -->
    <script>
        let currentDate = new Date();
        let allEvents = []; // Simpan semua event di sini

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/calendar');
                const data = await res.json();
                allEvents = data;
                renderCalendar();
            } catch (err) {
                console.error("Gagal ambil event:", err);
                renderCalendar(); 
            }
        });

        // --- FUNGSI RENDER KALENDAR (KOTAK-KOTAK) ---
        function renderCalendar() {
            const monthYearEl = document.getElementById('current-month-year');
            const calendarBody = document.getElementById('calendar-body');
            
            const monthName = currentDate.toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
            monthYearEl.innerText = monthName;

            const headers = Array.from(document.querySelectorAll('.calendar-day-header'));
            calendarBody.innerHTML = '';
            headers.forEach(h => calendarBody.appendChild(h));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.classList.add('bg-gray-50');
                calendarBody.appendChild(emptyDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'hover:bg-gray-50', 'transition');
                
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayDiv.classList.add('bg-blue-50');
                    dayDiv.innerHTML = `<span class="inline-flex items-center justify-center w-7 h-7 bg-sra-primary text-white rounded-full font-bold text-sm mb-1">${day}</span>`;
                } else {
                    dayDiv.innerHTML = `<span class="text-gray-700 font-semibold text-sm block mb-1">${day}</span>`;
                }

                const currentDayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const daysEvents = allEvents.filter(event => {
                    return currentDayStr >= event.start_date && currentDayStr <= event.end_date;
                });

                daysEvents.forEach(evt => {
                    let colorClass = 'bg-blue-100 text-blue-800 border-blue-200';
                    if (evt.category === 'cuti') colorClass = 'bg-red-100 text-red-800 border-red-200';
                    if (evt.category === 'exam') colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    if (evt.category === 'program') colorClass = 'bg-green-100 text-green-800 border-green-200';

                    const eventEl = document.createElement('div');
                    eventEl.className = `event-badge mt-1 px-1.5 py-0.5 rounded text-xs border ${colorClass} truncate cursor-pointer`;
                    eventEl.innerText = evt.title;
                    eventEl.title = evt.title;
                    eventEl.onclick = () => alert(`${evt.title}\n\nTarikh: ${evt.start_date} hingga ${evt.end_date}\nInfo: ${evt.description || '-'}`);

                    dayDiv.appendChild(eventEl);
                });

                calendarBody.appendChild(dayDiv);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        // --- FUNGSI MODAL SUMMARY (LIST VIEW) ---
        function openSummaryModal() {
            const modal = document.getElementById('summary-modal');
            const tbody = document.getElementById('summary-table-body');
            const noData = document.getElementById('no-data-msg');

            tbody.innerHTML = ''; // Kosongkan dulu

            if (allEvents.length === 0) {
                noData.classList.remove('hidden');
            } else {
                noData.classList.add('hidden');

                // 1. Susun ikut tarikh (Awal ke Akhir)
                const sortedEvents = allEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

                // 2. Generate Table Rows
                sortedEvents.forEach(evt => {
                    // Format Tarikh (12 Mei 2025)
                    const sDate = new Date(evt.start_date).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                    // const eDate = new Date(evt.end_date).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                    
                    // Badge Warna untuk Kategori
                    let badgeColor = 'bg-blue-100 text-blue-800';
                    let label = 'Lain-lain';
                    if (evt.category === 'cuti') { badgeColor = 'bg-red-100 text-red-800'; label = 'Cuti'; }
                    if (evt.category === 'exam') { badgeColor = 'bg-yellow-100 text-yellow-800'; label = 'Peperiksaan'; }
                    if (evt.category === 'program') { badgeColor = 'bg-green-100 text-green-800'; label = 'Program'; }

                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50 transition";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-600 font-medium whitespace-nowrap">
                            ${sDate}
                        </td>
                        <td class="p-3">
                            <div class="font-bold text-gray-800">${evt.title}</div>
                            ${evt.description ? `<div class="text-xs text-gray-500 mt-1">${evt.description}</div>` : ''}
                        </td>
                        <td class="p-3">
                            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${badgeColor}">
                                ${label}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Halang scroll belakang
        }

        function closeSummaryModal() {
            document.getElementById('summary-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>
