<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- URL LOGO JAIS -->
    <link rel="icon" type="image/png" href="https://kbwljjyzlmaclcrlmptg.supabase.co/storage/v1/object/public/images/jais.png"> 
    <title>Takwim Persekolahan - SRA Taman Kajang Raya</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sra: { primary: '#004D40', accent: '#FFC107', light: '#F5F5F5', dark: '#1F2937' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Style Grid Kalendar (Desktop Only) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
        }
        .calendar-day-header {
            background-color: #004D40;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- CSS KHAS UNTUK PRINT PDF --- */
        @media print {
            @page {
                margin: 1cm;
                size: A4 portrait;
            }

            /* Sembunyikan SEMUA elemen dalam body */
            body * {
                visibility: hidden;
            }

            /* Hanya tunjukkan Modal */
            #summary-modal, #summary-modal * {
                visibility: visible;
            }

            /* Sembunyikan Header Hijau & Butang dalam modal */
            #modal-top-bar, #modal-top-bar * {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
            }

            /* Reset Posisi Modal */
            #summary-modal {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                overflow: visible !important;
                z-index: 9999;
            }

            /* Reset Container Dalaman */
            #summary-modal .modal-content-wrapper {
                position: static !important;
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                transform: none !important;
            }

            /* Tunjuk Header Khas Print */
            .print-only-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                visibility: visible !important;
            }
            
            .print-only-header h1 {
                font-size: 18pt !important;
                margin-bottom: 5px;
            }

            /* Format Table Print */
            table {
                width: 100% !important;
                border-collapse: collapse;
                font-size: 10pt !important;
            }
            
            thead {
                display: table-header-group;
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
            }
            
            tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            th, td {
                border: 1px solid #000 !important;
                padding: 6px !important;
                color: #000 !important;
                vertical-align: middle;
            }

            /* Warna Badge */
            .bg-red-100 { background-color: #fee2e2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-yellow-100 { background-color: #fef9c3 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-green-100 { background-color: #dcfce7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-blue-100 { background-color: #dbeafe !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-purple-100 { background-color: #f3e8ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-indigo-100 { background-color: #e0e7ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-orange-100 { background-color: #ffedd5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-cyan-100 { background-color: #cffafe !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-sra-primary text-white sticky top-0 z-50 shadow-lg border-b-4 border-sra-accent no-print">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center space-x-3">
                <img src="https://kbwljjyzlmaclcrlmptg.supabase.co/storage/v1/object/public/images/jais.png" class="w-10 h-10 rounded-full bg-white border-2 border-sra-accent">
                <h1 class="text-md font-bold uppercase tracking-wide">SRA TAMAN KAJANG RAYA</h1>
            </a>
            <a href="/" class="text-sm font-bold hover:text-sra-accent"><i class="fas fa-home mr-2"></i> Utama</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 py-8 no-print">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-sra-primary">Takwim Persekolahan</h1>
            <p class="text-gray-600 mt-2">Jadual acara, peperiksaan dan cuti sekolah</p>
        </div>

        <!-- VIEW 1: DESKTOP ONLY (KALENDAR KOTAK) -->
        <div id="desktop-calendar-view" class="hidden md:block bg-white rounded-xl shadow-lg overflow-hidden max-w-6xl mx-auto mb-8">
            
            <!-- Controls -->
            <div class="flex items-center justify-between p-6 bg-sra-light border-b">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-left fa-lg"></i>
                </button>
                <h2 id="current-month-year" class="text-2xl font-bold text-gray-800 uppercase"></h2>
                <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-right fa-lg"></i>
                </button>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 px-6 py-4 text-xs border-b bg-white">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-100 border border-red-500 mr-2"></span> Cuti</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-100 border border-yellow-500 mr-2"></span> Peperiksaan</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-100 border border-green-500 mr-2"></span> Program</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-100 border border-blue-500 mr-2"></span> Sekolah</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-purple-100 border border-purple-500 mr-2"></span> UPKK</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-indigo-100 border border-indigo-500 mr-2"></span> PSRA</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-100 border border-orange-500 mr-2"></span> Perayaan</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-cyan-100 border border-cyan-500 mr-2"></span> Cuti Khas</div>
            </div>

            <!-- Grid -->
            <div class="calendar-grid" id="calendar-body">
                <div class="calendar-day-header">AHAD</div>
                <div class="calendar-day-header">ISNIN</div>
                <div class="calendar-day-header">SELASA</div>
                <div class="calendar-day-header">RABU</div>
                <div class="calendar-day-header">KHAMIS</div>
                <div class="calendar-day-header">JUMAAT</div>
                <div class="calendar-day-header">SABTU</div>
            </div>
            
            <!-- Butang Summary -->
            <div class="p-4 text-center border-t bg-gray-50">
                <button onclick="openSummaryModal()" class="text-sra-primary font-bold hover:underline">
                    <i class="fas fa-list-ul mr-2"></i> Lihat Senarai Penuh Aktiviti
                </button>
            </div>
        </div>

        <!-- VIEW 2: MOBILE ONLY (LIST) -->
        <div id="mobile-list-view" class="md:hidden">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden border-t-4 border-sra-primary">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-lg text-gray-800"><i class="fas fa-calendar-alt mr-2 text-sra-primary"></i> Aktiviti Tahunan</h2>
                </div>
                <div id="mobile-list-container" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>Memuatkan jadual...</div>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL SUMMARY -->
    <div id="summary-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm no-print" onclick="closeSummaryModal()"></div>
        
        <!-- Modal Panel -->
        <div class="modal-content-wrapper fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-6xl max-h-[90vh] flex flex-col">
                    
                    <!-- HEADER MODAL (Hidden masa Print) -->
                    <div id="modal-top-bar" class="bg-sra-primary px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                        <h3 class="text-lg font-bold text-white">Senarai Penuh Aktiviti</h3>
                        <div class="flex gap-3">
                            <button onclick="printTable()" class="bg-white text-sra-primary px-3 py-1 rounded text-sm font-bold hover:bg-gray-100">
                                <i class="fas fa-print mr-1"></i> Cetak / PDF
                            </button>
                            <button onclick="closeSummaryModal()" class="text-white hover:text-gray-300">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Header Khas Untuk Print -->
                    <div class="print-only-header hidden">
                        <h1 class="text-3xl font-bold text-black mb-2">Takwim Persekolahan SRA Taman Kajang Raya</h1>
                        <p class="text-sm text-gray-600 uppercase tracking-widest">Jadual Acara Tahunan</p>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 text-sm uppercase">
                                    <!-- 5 KOLUM HEADER (Center) -->
                                    <th class="p-3 border-b font-bold w-[12%] text-center">Mula</th>
                                    <th class="p-3 border-b font-bold w-[12%] text-center">Tamat</th>
                                    <th class="p-3 border-b font-bold w-[10%] text-center">Tempoh</th>
                                    <th class="p-3 border-b font-bold w-[46%] text-center pl-4">Acara</th>
                                    <th class="p-3 border-b font-bold w-[20%] text-center">Kategori</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="text-sm">
                                <!-- Table Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="bg-sra-primary text-gray-100 border-t-4 border-sra-accent py-6 text-center text-sm no-print">
        <p>&copy; 2025 SRA Taman Kajang Raya.</p>
    </footer>

    <!-- LOGIK JAVASCRIPT -->
    <script>
        let currentDate = new Date();
        let allEvents = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/calendar');
                const data = await res.json();
                allEvents = data;
                renderCalendar();      
                renderMobileList();    
            } catch (err) { console.error(err); }
        });

        function getCategoryStyle(category) {
            const cat = category ? category.toLowerCase() : '';
            let style = { css: 'bg-gray-100 text-gray-800 border-gray-200', label: 'Lain-lain' };
            if (cat === 'cuti') style = { css: 'bg-red-100 text-red-800 border-red-200', label: 'Cuti' };
            else if (cat === 'exam' || cat === 'peperiksaan') style = { css: 'bg-yellow-100 text-yellow-800 border-yellow-200', label: 'Peperiksaan' };
            else if (cat === 'program') style = { css: 'bg-green-100 text-green-800 border-green-200', label: 'Program' };
            else if (cat === 'sekolah') style = { css: 'bg-blue-100 text-blue-800 border-blue-200', label: 'Sekolah' };
            else if (cat === 'upkk') style = { css: 'bg-purple-100 text-purple-800 border-purple-200', label: 'UPKK' };
            else if (cat === 'psra') style = { css: 'bg-indigo-100 text-indigo-800 border-indigo-200', label: 'PSRA' };
            else if (cat === 'perayaan') style = { css: 'bg-orange-100 text-orange-800 border-orange-200', label: 'Perayaan' };
            else if (cat === 'cuti khas') style = { css: 'bg-cyan-100 text-cyan-800 border-cyan-200', label: 'Cuti Khas' };
            return style;
        }

        function renderCalendar() {
            const monthYearEl = document.getElementById('current-month-year');
            const calendarBody = document.getElementById('calendar-body');
            const monthName = currentDate.toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
            monthYearEl.innerText = monthName;

            const headers = Array.from(document.querySelectorAll('.calendar-day-header'));
            calendarBody.innerHTML = '';
            headers.forEach(h => calendarBody.appendChild(h));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayIndex; i++) {
                calendarBody.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'hover:bg-gray-50', 'transition');
                dayDiv.innerHTML = `<span class="text-gray-700 font-semibold text-sm block mb-1">${day}</span>`;
                
                const currentDayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daysEvents = allEvents.filter(event => currentDayStr >= event.start_date && currentDayStr <= event.end_date);

                daysEvents.forEach(evt => {
                    const style = getCategoryStyle(evt.category);
                    const eventEl = document.createElement('div');
                    eventEl.className = `event-badge mt-1 px-1.5 py-0.5 rounded text-xs border ${style.css} truncate cursor-pointer`;
                    eventEl.innerText = evt.title;
                    eventEl.title = evt.title;
                    eventEl.onclick = () => alert(`${evt.title}\n\nInfo: ${evt.description || '-'}`);
                    dayDiv.appendChild(eventEl);
                });
                calendarBody.appendChild(dayDiv);
            }
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function renderMobileList() {
            const container = document.getElementById('mobile-list-container');
            container.innerHTML = '';
            if (allEvents.length === 0) { container.innerHTML = '<div class="p-6 text-center text-gray-500">Tiada aktiviti dijadualkan.</div>'; return; }

            const sortedEvents = allEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

            sortedEvents.forEach(evt => {
                const d1 = new Date(evt.start_date);
                const d2 = new Date(evt.end_date);
                const dateStr1 = d1.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                const dateStr2 = d2.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                let finalDate = dateStr1;
                if (evt.start_date !== evt.end_date) finalDate = `${dateStr1} - ${dateStr2}`;

                const style = getCategoryStyle(evt.category);
                const html = `<div class="p-4 hover:bg-gray-50 transition flex gap-3 border-b border-gray-100">
                    <div class="flex-shrink-0 w-24 text-center border-r pr-3 flex flex-col justify-center">
                        <span class="block text-sm font-bold text-gray-800 leading-tight">${finalDate}</span>
                        <span class="block text-xs text-gray-500 uppercase mt-1">${d1.getFullYear()}</span>
                    </div>
                    <div>
                        <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase mb-1 ${style.css}">${style.label}</span>
                        <h3 class="font-bold text-gray-800 text-sm leading-tight mb-1">${evt.title}</h3>
                        ${evt.description ? `<p class="text-xs text-gray-500 line-clamp-2">${evt.description}</p>` : ''}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function openSummaryModal() {
            const tbody = document.getElementById('summary-table-body');
            tbody.innerHTML = '';
            
            const sortedEvents = allEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

            sortedEvents.forEach(evt => {
                const d1 = new Date(evt.start_date);
                const d2 = new Date(evt.end_date);
                
                // Format Tarikh
                const dateStr1 = d1.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
                // const dateStr2 = d2.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' }); // Digunakan jika tarikh beza
                
                // Papar Tarikh Tamat (Jika sama dengan mula, papar '-')
                let endDateDisplay = '-';
                if (evt.start_date !== evt.end_date) {
                    endDateDisplay = d2.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
                }

                // Kira Jumlah Hari
                const oneDay = 24 * 60 * 60 * 1000; 
                d1.setHours(0,0,0,0);
                d2.setHours(0,0,0,0);
                const diffDays = Math.round(Math.abs((d2 - d1) / oneDay)) + 1;

                const style = getCategoryStyle(evt.category);

                // --- GENERATE ROW (5 KOLUM) ---
                const tr = `
                <tr class="border-b hover:bg-gray-50 align-top break-inside-avoid">
                    <!-- KOLUM 1: MULA -->
                    <td class="p-3 text-center whitespace-nowrap text-gray-700 font-medium">
                        ${dateStr1}
                    </td>
                    
                    <!-- KOLUM 2: TAMAT -->
                    <td class="p-3 text-center whitespace-nowrap text-gray-700 font-medium">
                        ${endDateDisplay}
                    </td>

                    <!-- KOLUM 3: TEMPOH -->
                    <td class="p-3 text-center whitespace-nowrap">
                        <span class="text-gray-800 text-base font-bold">
                            ${diffDays} Hari
                        </span>
                    </td>

                    <!-- KOLUM 4: ACARA -->
                    <td class="p-3 pl-4 text-left align-middle">
                        <div class="text-gray-800 text-base leading-tight">${evt.title}</div>
                        ${evt.description ? `<div class="text-xs text-gray-500 mt-1">${evt.description}</div>` : ''}
                    </td>

                    <!-- KOLUM 5: KATEGORI -->
                    <td class="p-3 text-center align-middle">
                        <span class="inline-block px-2 py-1 rounded-full text-[10px] font-bold uppercase border ${style.css.replace('bg-', 'border-').replace('text-', 'text-')} bg-white">
                            ${style.label}
                        </span>
                    </td>
                </tr>`;
                tbody.innerHTML += tr;
            });
            document.getElementById('summary-modal').classList.remove('hidden');
        }

        function closeSummaryModal() {
            document.getElementById('summary-modal').classList.add('hidden');
        }

        function printTable() {
            window.print();
        }
    </script>
</body>
</html>
