<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- GANTIKAN DENGAN URL LOGO ANDA -->
    <link rel="icon" type="image/png" href="URL_LOGO_ANDA"> 
    <title>Takwim Persekolahan - SRA TKR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sra: { primary: '#004D40', accent: '#FFC107', light: '#F5F5F5', dark: '#1F2937' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Style Grid Kalendar (Desktop Only) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
        }
        .calendar-day-header {
            background-color: #004D40;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- CSS KHAS UNTUK PRINT PDF --- */
        @media print {
            /* Sembunyikan semua benda lain */
            body * {
                visibility: hidden;
            }
            /* Tunjuk Modal Summary Sahaja */
            #summary-modal, #summary-modal * {
                visibility: visible;
            }
            /* Format Modal untuk Kertas A4 */
            #summary-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
                overflow: visible !important;
            }
            #summary-modal .relative {
                box-shadow: none;
                max-width: 100%;
            }
            /* Sembunyikan butang tutup & butang print masa printing */
            .no-print {
                display: none !important;
            }
            /* Pastikan table nampak cantik */
            table {
                width: 100%;
                border: 1px solid #ddd;
                font-size: 12px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }
            /* Header Table */
            thead {
                background-color: #eee !important;
                -webkit-print-color-adjust: exact; 
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-sra-primary text-white sticky top-0 z-50 shadow-lg border-b-4 border-sra-accent no-print">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center space-x-3">
                <img src="URL_LOGO_ANDA" class="w-10 h-10 rounded-full bg-white border-2 border-sra-accent">
                <h1 class="text-md font-bold uppercase tracking-wide">SRA TKR</h1>
            </a>
            <a href="/" class="text-sm font-bold hover:text-sra-accent"><i class="fas fa-home mr-2"></i> Utama</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 py-8 no-print">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-sra-primary">Takwim Persekolahan</h1>
            <p class="text-gray-600 mt-2">Jadual acara, peperiksaan dan cuti sekolah</p>
        </div>

        <!-- ============================================= -->
        <!-- VIEW 1: DESKTOP ONLY (KALENDAR KOTAK) -->
        <!-- ============================================= -->
        <div id="desktop-calendar-view" class="hidden md:block bg-white rounded-xl shadow-lg overflow-hidden max-w-6xl mx-auto mb-8">
            
            <!-- Controls -->
            <div class="flex items-center justify-between p-6 bg-sra-light border-b">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-left fa-lg"></i>
                </button>
                <h2 id="current-month-year" class="text-2xl font-bold text-gray-800 uppercase"></h2>
                <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200 transition text-sra-primary">
                    <i class="fas fa-chevron-right fa-lg"></i>
                </button>
            </div>

            <!-- Legend / Petunjuk Warna (Updated with New Categories) -->
            <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 px-6 py-4 text-xs border-b bg-white">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-100 border border-red-500 mr-2"></span> Cuti</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-100 border border-yellow-500 mr-2"></span> Peperiksaan</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-100 border border-green-500 mr-2"></span> Program</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-100 border border-blue-500 mr-2"></span> Sekolah</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-purple-100 border border-purple-500 mr-2"></span> UPKK</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-indigo-100 border border-indigo-500 mr-2"></span> PSRA</div>
                <!-- Kategori Baru -->
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-100 border border-orange-500 mr-2"></span> Perayaan</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-cyan-100 border border-cyan-500 mr-2"></span> Cuti Khas</div>
            </div>

            <!-- Grid -->
            <div class="calendar-grid" id="calendar-body">
                <div class="calendar-day-header">AHAD</div>
                <div class="calendar-day-header">ISNIN</div>
                <div class="calendar-day-header">SELASA</div>
                <div class="calendar-day-header">RABU</div>
                <div class="calendar-day-header">KHAMIS</div>
                <div class="calendar-day-header">JUMAAT</div>
                <div class="calendar-day-header">SABTU</div>
                <!-- Tarikh dijana oleh JS -->
            </div>
            
            <!-- Butang Buka Modal Summary -->
            <div class="p-4 text-center border-t bg-gray-50">
                <button onclick="openSummaryModal()" class="text-sra-primary font-bold hover:underline">
                    <i class="fas fa-list-ul mr-2"></i> Lihat Senarai Penuh Aktiviti
                </button>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- VIEW 2: MOBILE ONLY (SENARAI LIST) -->
        <!-- ============================================= -->
        <div id="mobile-list-view" class="md:hidden">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden border-t-4 border-sra-primary">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-lg text-gray-800"><i class="fas fa-calendar-alt mr-2 text-sra-primary"></i> Aktiviti Tahunan</h2>
                </div>
                
                <div id="mobile-list-container" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>Memuatkan jadual...
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL SUMMARY (UNTUK DESKTOP TABLE VIEW & PRINT) -->
    <div id="summary-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm no-print" onclick="closeSummaryModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-6xl max-h-[90vh] flex flex-col">
                    
                    <!-- Header Modal -->
                    <div class="bg-sra-primary px-6 py-4 flex justify-between items-center sticky top-0 z-20 no-print">
                        <h3 class="text-lg font-bold text-white">Senarai Penuh Aktiviti</h3>
                        <div class="flex gap-3">
                            <!-- Butang Print -->
                            <button onclick="printTable()" class="bg-white text-sra-primary px-3 py-1 rounded text-sm font-bold hover:bg-gray-100">
                                <i class="fas fa-print mr-1"></i> Cetak / PDF
                            </button>
                            <!-- Butang Tutup -->
                            <button onclick="closeSummaryModal()" class="text-white hover:text-gray-300">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tajuk Khas Untuk Print (Hidden by default) -->
                    <div class="hidden print:block text-center p-4 mb-4 border-b">
                        <h1 class="text-2xl font-bold">Takwim Persekolahan SRA Taman Kajang Raya</h1>
                        <p class="text-sm text-gray-600">Jadual Acara Tahunan</p>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 text-sm uppercase">
                                    <th class="p-3 border-b font-bold w-[25%]">Tarikh</th>
                                    <!-- Column Baru: Tempoh -->
                                    <th class="p-3 border-b font-bold w-[10%] text-center">Tempoh</th>
                                    <th class="p-3 border-b font-bold w-[45%]">Acara</th>
                                    <th class="p-3 border-b font-bold w-[20%] text-right">Kategori</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="text-sm">
                                <!-- Table rows generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="bg-sra-primary text-gray-100 border-t-4 border-sra-accent py-6 text-center text-sm no-print">
        <p>&copy; 2025 SRA Taman Kajang Raya.</p>
    </footer>

    <!-- LOGIK JAVASCRIPT -->
    <script>
        let currentDate = new Date();
        let allEvents = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/calendar');
                const data = await res.json();
                allEvents = data;
                
                renderCalendar();      
                renderMobileList();    
            } catch (err) {
                console.error("Gagal ambil event:", err);
            }
        });

        // --- Helper Function: Tentukan Warna Kategori ---
        function getCategoryStyle(category) {
            const cat = category ? category.toLowerCase() : '';
            let style = { css: 'bg-gray-100 text-gray-800 border-gray-200', label: 'Lain-lain' };

            if (cat === 'cuti') style = { css: 'bg-red-100 text-red-800 border-red-200', label: 'Cuti' };
            else if (cat === 'exam' || cat === 'peperiksaan') style = { css: 'bg-yellow-100 text-yellow-800 border-yellow-200', label: 'Peperiksaan' };
            else if (cat === 'program') style = { css: 'bg-green-100 text-green-800 border-green-200', label: 'Program' };
            else if (cat === 'sekolah') style = { css: 'bg-blue-100 text-blue-800 border-blue-200', label: 'Sekolah' };
            else if (cat === 'upkk') style = { css: 'bg-purple-100 text-purple-800 border-purple-200', label: 'UPKK' };
            else if (cat === 'psra') style = { css: 'bg-indigo-100 text-indigo-800 border-indigo-200', label: 'PSRA' };
            // Kategori Baru
            else if (cat === 'perayaan') style = { css: 'bg-orange-100 text-orange-800 border-orange-200', label: 'Perayaan' };
            else if (cat === 'cuti khas') style = { css: 'bg-cyan-100 text-cyan-800 border-cyan-200', label: 'Cuti Khas' };

            return style;
        }

        // --- 1. RENDER KALENDAR KOTAK (DESKTOP) ---
        function renderCalendar() {
            const monthYearEl = document.getElementById('current-month-year');
            const calendarBody = document.getElementById('calendar-body');
            
            const monthName = currentDate.toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
            monthYearEl.innerText = monthName;

            const headers = Array.from(document.querySelectorAll('.calendar-day-header'));
            calendarBody.innerHTML = '';
            headers.forEach(h => calendarBody.appendChild(h));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayIndex; i++) {
                calendarBody.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'hover:bg-gray-50', 'transition');
                dayDiv.innerHTML = `<span class="text-gray-700 font-semibold text-sm block mb-1">${day}</span>`;

                const currentDayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const daysEvents = allEvents.filter(event => {
                    return currentDayStr >= event.start_date && currentDayStr <= event.end_date;
                });

                daysEvents.forEach(evt => {
                    const style = getCategoryStyle(evt.category);
                    const eventEl = document.createElement('div');
                    eventEl.className = `event-badge mt-1 px-1.5 py-0.5 rounded text-xs border ${style.css} truncate cursor-pointer`;
                    eventEl.innerText = evt.title;
                    eventEl.title = evt.title;
                    eventEl.onclick = () => alert(`${evt.title}\n\nInfo: ${evt.description || '-'}`);
                    dayDiv.appendChild(eventEl);
                });

                calendarBody.appendChild(dayDiv);
            }
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        // --- 2. RENDER LIST (MOBILE) ---
        function renderMobileList() {
            const container = document.getElementById('mobile-list-container');
            container.innerHTML = '';

            if (allEvents.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">Tiada aktiviti dijadualkan.</div>';
                return;
            }

            const sortedEvents = allEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

            sortedEvents.forEach(evt => {
                const d1 = new Date(evt.start_date);
                const d2 = new Date(evt.end_date);
                const dateStr1 = d1.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                const dateStr2 = d2.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
                
                let finalDate = dateStr1;
                if (evt.start_date !== evt.end_date) {
                    finalDate = `${dateStr1} - ${dateStr2}`;
                }

                const style = getCategoryStyle(evt.category);

                const html = `
                <div class="p-4 hover:bg-gray-50 transition flex gap-3 border-b border-gray-100">
                    <div class="flex-shrink-0 w-24 text-center border-r pr-3 flex flex-col justify-center">
                        <span class="block text-sm font-bold text-gray-800 leading-tight">${finalDate}</span>
                        <span class="block text-xs text-gray-500 uppercase mt-1">${d1.getFullYear()}</span>
                    </div>
                    <div>
                        <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase mb-1 ${style.css}">${style.label}</span>
                        <h3 class="font-bold text-gray-800 text-sm leading-tight mb-1">${evt.title}</h3>
                        ${evt.description ? `<p class="text-xs text-gray-500 line-clamp-2">${evt.description}</p>` : ''}
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- 3. MODAL SUMMARY (TABLE VIEW + JUMLAH HARI) ---
        function openSummaryModal() {
            const tbody = document.getElementById('summary-table-body');
            tbody.innerHTML = '';
            
            const sortedEvents = allEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

            sortedEvents.forEach(evt => {
                const d1 = new Date(evt.start_date);
                const d2 = new Date(evt.end_date);
                const dateStr1 = d1.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
                const dateStr2 = d2.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });

                // Kira Jumlah Hari
                // Formula: (Beza Masa / Milliseconds dalam sehari) + 1
                const oneDay = 24 * 60 * 60 * 1000; 
                // Reset jam ke 00:00 untuk kiraan tepat
                d1.setHours(0,0,0,0);
                d2.setHours(0,0,0,0);
                const diffDays = Math.round(Math.abs((d2 - d1) / oneDay)) + 1;

                let displayDateHtml = `<span class="font-bold text-gray-700">${dateStr1}</span>`;
                if (evt.start_date !== evt.end_date) {
                    displayDateHtml = `
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-700">${dateStr1}</span>
                            <span class="text-xs text-gray-400 font-medium my-0.5">hingga</span>
                            <span class="font-bold text-gray-700">${dateStr2}</span>
                        </div>
                    `;
                }

                const style = getCategoryStyle(evt.category);

                const tr = `
                <tr class="border-b hover:bg-gray-50 align-top break-inside-avoid">
                    <td class="p-4 whitespace-nowrap align-middle">
                        ${displayDateHtml}
                    </td>
                    <!-- Column Jumlah Hari -->
                    <td class="p-4 align-middle text-center">
                        <span class="font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded text-xs border border-gray-200">
                            ${diffDays} Hari
                        </span>
                    </td>
                    <td class="p-4 align-middle">
                        <div class="font-bold text-gray-800 text-base">${evt.title}</div>
                        <div class="text-sm text-gray-500 mt-1">${evt.description || ''}</div>
                    </td>
                    <td class="p-4 align-middle text-right">
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase shadow-sm ${style.css}">
                            ${style.label}
                        </span>
                    </td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            document.getElementById('summary-modal').classList.remove('hidden');
        }

        function closeSummaryModal() {
            document.getElementById('summary-modal').classList.add('hidden');
        }

        // --- 4. FUNGSI PRINT PDF ---
        function printTable() {
            window.print();
        }
    </script>
</body>
</html>
